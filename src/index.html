<!DOCTYPE html>
<html lang="ja">
<head>
    <META HTTP-EQUIV="CACHE-CONTROL" CONTENT="NO-CACHE">
    <META HTTP-EQUIV="PRAGMA" CONTENT="NO-CACHE">
    <meta http-equiv="Expires" content="Thu, 01 Dec 1994 16:00:00 GMT">
    <meta charset="UTF-8">
    <title>peer.io</title>

    <!-- build:dependeny dependencies.js -->
    <script src="./bower_components/jquery/dist/jquery.js"></script>
    <script src="./bower_components/offline/offline.js"></script>
    <script src="./bower_components/lodash/lodash.js"></script>
    <script src="./bower_components/eventemitter2/lib/eventemitter2.js"></script>
    <script src="./bower_components/peerjs/peer.js"></script>
    <!-- endbuild -->
    <!-- build:js peer.io.js -->
    <script src="./models/states/offline_state.js"></script>
    <script src="./models/states/online_state.js"></script>
    <script src="./models/states/connected_state.js"></script>
    <script src="./models/states/wait_closing_state.js"></script>
    <script src="./models/states/peerjs_state.js"></script>
    <script src="./models/neighbour.js"></script>
    <script src="./models/target_neighbours.js"></script>
    <script src="./models/peerjs_manager.js"></script>
    <script src="models/util.js"></script>
    <script src="./peer.io.js"></script>
    <!-- endbuild -->

    <script type="text/javascript">
        localStorage.clear();

        function getQueryString() {
            if (1 < document.location.search.length) {
                var query = document.location.search.substring(1);
                var parameters = query.split('&');
                var result = new Object();
                for (var i = 0; i < parameters.length; i++) {
                    var element = parameters[i].split('=');
                    var paramName = decodeURIComponent(element[0]);
                    var paramValue = decodeURIComponent(element[1]);
                    result[paramName] = decodeURIComponent(paramValue);
                }
                return result;
            }
            return null;
        }

        window.onload = function(){
            function startPeerIo(streams){
                var newStream = new webkitMediaStream();
                newStream.addTrack(streams[0].getVideoTracks()[0]);
                newStream.addTrack(streams[1].getVideoTracks()[0]);
                var query = getQueryString();

                var peer = new Peer(query['id'], {
                    config: {"iceServers":[
                        {"url": "stun:stun.skyway.io:3478"}
                    ]},
                    host: 'robo.paas.jp-e1.cloudn-service.com',
                    port: 443,
                    secure: true,
                    key: 'DEl4XWDPustUHICCl8cZ',
                    debug: 0});

                var peerIo = new PeerIo.PeerIo(peer);
                peerIo.addDefaultStream(newStream);

                var counter = 0;
                peerIo.onStream = function(peerId, stream){
                    var tracks = stream.getVideoTracks();
                    if(tracks.length > 1){
                        $("#leftVideo").get(0).src = window.URL.createObjectURL(stream);
                        var nn = new webkitMediaStream();
                        nn.addTrack(tracks[1]);
                        $("#rightVideo").get(0).src = window.URL.createObjectURL(stream);
                    }
                    else $("#leftVideo").get(0).src = window.URL.createObjectURL(nn);
                    counter ++;
                };

                peerIo.addNeighbour(query['target'], Model.NeighbourTypeEnum.video, newStream);
            }

            navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
            navigator.getUserMedia({
                audio: true,
                video: true
            }, function (stream) {
                navigator.getUserMedia({
                    audio: true,
                    video: true
                }, function (stream2) {
                    var array=[];
                    array.push(stream);
                    array.push(stream2);
                    startPeerIo(array);
                }, function () {
                }, function (err) {
                });
            }, function () {
            }, function (err) {
            });


            console.log(Offline.state);
            Offline.check();
        };

    </script>
</head>
<body>
<video id="leftVideo" name="leftVideo" autoplay width="640" height="480" class="left"></video>
<video id="rightVideo" name="rightVideo" autoplay width="640" heigh="480"></video>
<div class="clear"></div>
<div id="comment" name="comment"></div>
</body>
</html>
