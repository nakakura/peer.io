var PeerIo;!function(e){var t=function(){function t(){}return t.prototype.state=function(){return e.PeerJsStateEnum.initial},t.prototype.network=function(t,n){n&&t.setStateObject(new e.OnlineState)},t.prototype.peer=function(e,t){},t}();e.OfflineState=t}(PeerIo||(PeerIo={}));var PeerIo;!function(e){var t=function(){function t(){}return t.prototype.state=function(){return e.PeerJsStateEnum.online},t.prototype.network=function(t,n){n||t.setStateObject(new e.OfflineState)},t.prototype.peer=function(t,n){n&&t.setStateObject(new e.ConnectedState)},t}();e.OnlineState=t}(PeerIo||(PeerIo={}));var PeerIo;!function(e){var t=function(){function t(){}return t.prototype.state=function(){return e.PeerJsStateEnum.connected},t.prototype.network=function(t,n){n||t.setStateObject(new e.WaitClosingState)},t.prototype.peer=function(t,n){n||t.setStateObject(new e.OnlineState)},t}();e.ConnectedState=t}(PeerIo||(PeerIo={}));var PeerIo;!function(e){var t=function(){function t(){}return t.prototype.state=function(){return e.PeerJsStateEnum.wait_closing},t.prototype.network=function(t,n){n&&t.setStateObject(new e.ConnectedState)},t.prototype.peer=function(t,n){n||t.setStateObject(new e.OfflineState)},t}();e.WaitClosingState=t}(PeerIo||(PeerIo={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},PeerIo;!function(e){!function(e){e[e.initial=1]="initial",e[e.online=2]="online",e[e.connected=3]="connected",e[e.wait_closing=4]="wait_closing"}(e.PeerJsStateEnum||(e.PeerJsStateEnum={}));var t=(e.PeerJsStateEnum,function(t){function n(){t.call(this),this._ON_STATE_CHANGED="onStateCahnged",this._state=new e.OfflineState}return __extends(n,t),n.prototype.state=function(){return this._state.state()},n.prototype.stateObject=function(){return this._state},n.prototype.setStateObject=function(e){this._state=e,this.emit(this._ON_STATE_CHANGED,e.state())},n.prototype.onStateChanged=function(e){this.on(this._ON_STATE_CHANGED,e)},n}(EventEmitter2));e.PeerJsStateManager=t}(PeerIo||(PeerIo={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},PeerIo;!function(e){e.OnNeighbourDown="onNeighbourDown-in-neighbour.ts",e.OnStream="onStream-in-neighbour.ts",e.OnData="onData-in-neighbour.ts",function(e){e[e.video=1]="video",e[e.data=2]="data"}(e.NeighbourTypeEnum||(e.NeighbourTypeEnum={}));var t=e.NeighbourTypeEnum,n=function(e){function t(t){e.call(this),this._peerID=t}return __extends(t,e),t.prototype.key=function(){return"this must not called"},t.prototype.active=function(){return!1},t.prototype.connected=function(){return!1},t.prototype.type=function(){return null},t.prototype.peerID=function(){return this._peerID},t.prototype.sources=function(){return[]},t.prototype.setChannel=function(e){},t.prototype.setSource=function(e){},t.prototype.send=function(e){},t.prototype.close=function(){},t}(EventEmitter2);e.NeighbourTemplate=n;var o=function(n){function o(){n.apply(this,arguments),this._dataChannel=null,this._connecting=!1,this._startTime=-1}return __extends(o,n),o.prototype.type=function(){return t.data},o.prototype.key=function(){return this._peerID+"-data"},o.prototype.active=function(){var e=(new Date).getTime();return this.connected()||this._connecting&&e-this._startTime<1e3},o.prototype.connected=function(){return this._dataChannel?this._dataChannel.open:!1},o.prototype.setChannel=function(t){var n=this;this._startTime=(new Date).getTime(),this._dataChannel=t,this._connecting=!0,t.on("open",function(){n._connecting=!1}),t.on("close",function(){n._connecting=!1,n._dataChannel=null,n.emit(e.OnNeighbourDown)}),t.on("error",function(e){n._connecting=!1,n._dataChannel=null}),t.on("data",function(t){n.emit(e.OnData,t)})},o.prototype.send=function(e){this.connected()&&this._dataChannel&&this._dataChannel.send(e)},o.prototype.close=function(){this._connecting=!1,this._dataChannel=null},o}(n);e.DataNeighbour=o;var i=function(n){function o(){n.apply(this,arguments),this._mediaConnection=null,this._sources=[],this._connecting=!1,this._startTime=-1}return __extends(o,n),o.prototype.type=function(){return t.video},o.prototype.key=function(){return this._peerID+"-video"},o.prototype.active=function(){var e=(new Date).getTime();return this.connected()||this._connecting&&e-this._startTime<1e3},o.prototype.connected=function(){return this._mediaConnection?this._mediaConnection.open:!1},o.prototype.sources=function(){return this._sources},o.prototype.setChannel=function(t){var n=this;this._startTime=(new Date).getTime(),this._connecting=!0,this._mediaConnection=t,t.on("stream",function(t){n._connecting=!1,n._mediaConnection=t,n.emit(e.OnStream,t)}),t.on("close",function(){n._connecting=!1,n._mediaConnection=null,n.emit(e.OnNeighbourDown)}),t.on("error",function(e){n._connecting=!1,n._mediaConnection=null})},o.prototype.setSource=function(e){e instanceof Array?Array.prototype.push.apply(this._sources,e):this._sources.push(e)},o.prototype.close=function(){this._connecting=!1,this._mediaConnection=null},o}(n);e.VideoNeighbour=i;var r=function(){function e(){}return e.createNeighbour=function(e,n){switch(n){case t.video:return new i(e);case t.data:return new o(e)}},e}();e.NeighbourFactory=r}(PeerIo||(PeerIo={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},PeerIo;!function(e){e.ON_NEED_ESTABLISH_LINK="onNeedEstablishLink-in-targetneighbours.ts",e.ON_NEED_CLOSE_LINK="onNeedCloseLink-in-targetneighbours.ts";var t=function(t){function n(){var e=this;t.call(this),this._neighbours={},this.targetNeighbours=function(){var t=_.filter(e._neighbours,function(e,t){return!e.active()});return t},this.findNeighbour=function(t){return e._neighbours[t]},this.connectedNeighbours=function(){var t=_.filter(e._neighbours,function(e,t){return e.connected()});return t}}return __extends(n,t),n.prototype.tryAddNeighbour=function(t){if(t.connected())console.log("すでにconnectedだった"),this.removeNeighbour(t.key());else if(t.key()in this._neighbours&&this._neighbours[t.key()].active())return t.close(),console.log("activeだからあきらめた"),!1;return console.log("その他"),console.log(t.key()),this.removeNeighbour(t.key()),this._neighbours[t.key()]=t,t.active()||(console.log("on need "+t.key()),this.emit(e.ON_NEED_ESTABLISH_LINK,t)),!0},n.prototype.removeNeighbour=function(e){e in this._neighbours&&(this._neighbours[e].close(),delete this._neighbours[e])},n}(EventEmitter2);e.TargetNeighbours=t}(PeerIo||(PeerIo={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},PeerIo;!function(e){var t=function(t){function n(n){var o=this;t.call(this),this._peer=n,this.ON_LINK_FROM_NEIGHBOUR="onLinkFromNeighbour-in-peerjs_manager.ts",this._neighbourSources={},this._defaultStream=[],this._onOnline=function(e){o._state.stateObject().network(o._state,e)},this._onOpenPeer=function(){o._state.stateObject().peer(o._state,!0)},this._onClosePeer=function(){o._state.stateObject().peer(o._state,!1)},this._onStateChanged=function(t){switch(t){case e.PeerJsStateEnum.initial:break;case e.PeerJsStateEnum.online:o._peer.disconnected||o._state.stateObject().peer(o._state,!0);break;case e.PeerJsStateEnum.connected:setTimeout(o._establishAllPeer,e.Util.waitTime(0,2e3));break;case e.PeerJsStateEnum.wait_closing:}},this._establishAllPeer=function(){console.log("establish all peer"),_.each(o._targetNeighbours(),o.establishLink)},this.establishLink=function(t){switch(t.type()){case e.NeighbourTypeEnum.video:console.log("establish video in establish link"),o._tryCall(t);break;case e.NeighbourTypeEnum.data:console.log("establish data in establish link"),o._tryConnect(t)}},this._onRecvCall=function(t){console.log("recvcall");var n=t.peer;t.answer(o._defaultStream[0]);var i=o._targetNeighbours();if(i.hasOwnProperty(n)&&i[n].type()===e.NeighbourTypeEnum.video)t.close();else{var r=e.NeighbourFactory.createNeighbour(n,e.NeighbourTypeEnum.video);r.setChannel(t),o.emit(o.ON_LINK_FROM_NEIGHBOUR,r)}},this._onRecvConnect=function(t){console.log("recvconnect");var n=t.peer,i=o._targetNeighbours();if(i.hasOwnProperty(n)&&i[n].type()===e.NeighbourTypeEnum.video)t.close();else{var r=e.NeighbourFactory.createNeighbour(n,e.NeighbourTypeEnum.data);r.setChannel(t),o.emit(o.ON_LINK_FROM_NEIGHBOUR,r)}},this._state=new e.PeerJsStateManager,this._state.onStateChanged(this._onStateChanged),this._checkNetworkStatus(),this._wrapPeerEvent()}return __extends(n,t),n.prototype._checkNetworkStatus=function(){var e=this;Offline.options={checks:{xhr:{url:"https://skyway.io/dist/0.3/peer.min.js"}}},Offline.on("up",function(){e._state.stateObject().network(e._state,!0)}),Offline.on("down",function(){e._state.stateObject().network(e._state,!1)}),"up"===Offline.state&&this._state.stateObject().network(this._state,!0),Offline.check()},n.prototype.addDefaultStream=function(e){e instanceof Array?Array.prototype.push.apply(this._defaultStream,e):this._defaultStream.push(e)},n.prototype.clearDefaultStream=function(){this._defaultStream=[]},n.prototype.addNeighboursSource=function(e,t){e in this._neighbourSources||(this._neighbourSources[e]=t)},n.prototype.removeNeighboursSource=function(e){e in this._neighbourSources&&delete this._neighbourSources[e]},n.prototype._wrapPeerEvent=function(){this._peer.on("open",this._onOpenPeer),this._peer.on("error",function(e){console.log(e)}),this._peer.on("disconnected",this._onClosePeer),this._peer.on("connection",this._onRecvConnect),this._peer.on("call",this._onRecvCall)},n.prototype._tryCall=function(e){var t=e.sources(),n=this._peer.call(e.peerID(),t[0]);e.setChannel(n)},n.prototype._tryConnect=function(e){var t=this._peer.connect(e.peerID(),{label:"json",serialization:"none",reliable:!1});e.setChannel(t)},n.prototype._targetNeighbours=function(){return _.reduce(this._neighbourSources,function(e,t,n){return $.extend(e,t())},[])},n}(EventEmitter2);e.PeerJsManager=t}(PeerIo||(PeerIo={}));var PeerIo;!function(e){var t=function(){function e(){}return e.waitTime=function(e,t){return e+Math.random()*(t-e)},e}();e.Util=t}(PeerIo||(PeerIo={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},PeerIo;!function(e){e.OnVideoLinkUp="onVideoLinkUp",e.OnVideoLinkDown="onVideoLinkDown",e.OnRecvVideo="onRecvVideo",e.OnDataLinkUp="onDataLinkUp",e.OnDataLinkDown="onDataLinkDown",e.OnRecvData="onRecvData",function(e){e[e.videoLinkUp=1]="videoLinkUp",e[e.recvVideo=2]="recvVideo",e[e.dataLinkUp=3]="dataLinkUp",e[e.recvData=4]="recvData"}(e.EventTypeEnum||(e.EventTypeEnum={}));var t=(e.EventTypeEnum,function(t){function n(n){var o=this;t.call(this),this._onLinkFromNeighbour=function(e){o._targetNeighbours.tryAddNeighbour(e)&&o._addCallbackToNeighbour(e)},this._targetNeighbours=new e.TargetNeighbours,this._peerJsManager=new e.PeerJsManager(n),this._peerJsManager.addNeighboursSource("targetNeighbours",this._targetNeighbours.targetNeighbours),this._peerJsManager.on(this._peerJsManager.ON_LINK_FROM_NEIGHBOUR,this._onLinkFromNeighbour),this._targetNeighbours.on(e.ON_NEED_ESTABLISH_LINK,this._peerJsManager.establishLink)}return __extends(n,t),n.prototype.addDefaultStream=function(e){this._peerJsManager.addDefaultStream(e)},n.prototype.addNeighbour=function(t,n,o){var i=e.NeighbourFactory.createNeighbour(t,n);o&&i.setSource(o),this._targetNeighbours.tryAddNeighbour(i)&&this._addCallbackToNeighbour(i)},n.prototype._addCallbackToNeighbour=function(t){var n=this;switch(t.type()){case e.NeighbourTypeEnum.video:t.on(e.OnStream,function(o){n.emit(e.OnRecvVideo,t.peerID(),o)}),t.on(e.OnNeighbourDown,function(){n.emit(e.OnVideoLinkDown,t.peerID())});break;case e.NeighbourTypeEnum.data:t.on(e.OnData,function(o){n.emit(e.OnRecvData,t.peerID(),o)}),t.on(e.OnNeighbourDown,function(){n.emit(e.OnDataLinkDown,t.peerID())})}},n.prototype.send=function(e,t){var n=this._targetNeighbours.findNeighbour(e+"-data");n&&n.send(t)},n.prototype.broadcast=function(e){var t=this._targetNeighbours.connectedNeighbours();_.each(t,function(t){t.send(e)})},n}(EventEmitter2));e.PeerIo=t}(PeerIo||(PeerIo={}));