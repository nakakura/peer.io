var Model;!function(t){var e=function(){function e(){}return e.prototype.state=function(){return t.PeerJsStateEnum.initial},e.prototype.network=function(e,n){n&&e.setStateObject(new t.OnlineState)},e.prototype.peer=function(t,e){},e}();t.OfflineState=e}(Model||(Model={}));var Model;!function(t){var e=function(){function e(){}return e.prototype.state=function(){return t.PeerJsStateEnum.online},e.prototype.network=function(e,n){n||e.setStateObject(new t.OfflineState)},e.prototype.peer=function(e,n){n&&e.setStateObject(new t.ConnectedState)},e}();t.OnlineState=e}(Model||(Model={}));var Model;!function(t){var e=function(){function e(){}return e.prototype.state=function(){return t.PeerJsStateEnum.connected},e.prototype.network=function(e,n){n||e.setStateObject(new t.WaitClosingState)},e.prototype.peer=function(e,n){n||e.setStateObject(new t.OnlineState)},e}();t.ConnectedState=e}(Model||(Model={}));var Model;!function(t){var e=function(){function e(){}return e.prototype.state=function(){return t.PeerJsStateEnum.wait_closing},e.prototype.network=function(e,n){n&&e.setStateObject(new t.ConnectedState)},e.prototype.peer=function(e,n){n||e.setStateObject(new t.OfflineState)},e}();t.WaitClosingState=e}(Model||(Model={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},Model;!function(t){!function(t){t[t.initial=1]="initial",t[t.online=2]="online",t[t.connected=3]="connected",t[t.wait_closing=4]="wait_closing"}(t.PeerJsStateEnum||(t.PeerJsStateEnum={}));var e=(t.PeerJsStateEnum,function(e){function n(){e.call(this),this._ON_STATE_CHANGED="onStateCahnged",this._state=new t.OfflineState}return __extends(n,e),n.prototype.state=function(){return this._state.state()},n.prototype.stateObject=function(){return this._state},n.prototype.setStateObject=function(t){this._state=t,this.emit(this._ON_STATE_CHANGED,t.state())},n.prototype.onStateChanged=function(t){this.on(this._ON_STATE_CHANGED,t)},n}(EventEmitter2));t.PeerJsStateManager=e}(Model||(Model={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},Model;!function(t){!function(t){t[t.video=1]="video",t[t.data=2]="data"}(t.NeighbourTypeEnum||(t.NeighbourTypeEnum={}));var e=t.NeighbourTypeEnum,n=function(t){function n(e){var n=this;t.call(this),this._peerID=e,this._dataChannel=null,this._connected=!1,this._callbacks=[],this.onStream=function(t){},this.onData=function(t){n._callbacks.push(t)}}return __extends(n,t),n.prototype.peerID=function(){return this._peerID},n.prototype.type=function(){return e.data},n.prototype.connected=function(){return this._connected},n.prototype.sources=function(){return[]},n.prototype.setChannel=function(t){var e=this;t&&(this._dataChannel=t,this._connected=!1,t.on("open",function(){e._connected=!0}),t.on("close",function(){e._dataChannel=null,e._connected=!1}),t.on("error",function(t){e._dataChannel=null,e._connected=!1}),t.on("data",function(t){_.each(e._callbacks,function(n){n(e._peerID,t)})}))},n.prototype.setSource=function(t){},n.prototype.send=function(t){this._connected&&this._dataChannel&&this._dataChannel.send(t)},n.prototype.close=function(){this._dataChannel.close(),this._dataChannel=null,this._connected=!1},n}(EventEmitter2);t.DataNeighbour=n;var o=function(t){function n(e){var n=this;t.call(this),this._peerID=e,this._mediaConnection=null,this._connected=!1,this._sources=[],this._callbacks=[],this.onStream=function(t){n._callbacks.push(t)},this.onData=function(t){}}return __extends(n,t),n.prototype.peerID=function(){return this._peerID},n.prototype.type=function(){return e.video},n.prototype.connected=function(){return this._connected},n.prototype.sources=function(){return this._sources},n.prototype.setChannel=function(t){var e=this;this._mediaConnection=t,this._connected=!1,t.on("stream",function(t){e._mediaConnection=t,e._connected=!0,_.each(e._callbacks,function(n){n(e._peerID,t)})}),t.on("close",function(){e._mediaConnection=null,e._connected=!1}),t.on("error",function(t){e._mediaConnection=null,e._connected=!1})},n.prototype.setSource=function(t){t instanceof Array?Array.prototype.push.apply(this._sources,t):this._sources.push(t)},n.prototype.send=function(t){},n.prototype.close=function(){this._mediaConnection.close(),this._mediaConnection=null,this._connected=!1},n}(EventEmitter2);t.VideoNeighbour=o;var i=function(){function t(){}return t.createNeighbour=function(t,i){switch(i){case e.video:return new o(t);case e.data:return new n(t)}},t}();t.NeighbourFactory=i}(Model||(Model={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},Model;!function(t){var e=function(t){function e(){var e=this;t.call(this),this._neighbours=[],this._ON_NEED_ESTABLISH_P2P="onNeedEstablishP2P",this._ON_NEED_CLOSE_P2P="onNeedCloseP2P",this.targetNeighbours=function(){var t=_.filter(e._neighbours,function(t){return!t.connected()});return t}}return __extends(e,t),e.prototype.onNeedEstablishLink=function(t){this.on(this._ON_NEED_ESTABLISH_P2P,t)},e.prototype.onNeedCloseLink=function(t){this.on(this._ON_NEED_CLOSE_P2P,t)},e.prototype.addNeighbour=function(t){var e=_.find(this._neighbours,function(e){return e.peerID()===t.peerID()&&e.type()===t.type()});return e?void this.emit(this._ON_NEED_CLOSE_P2P,t):(this._neighbours.push(t),void(t.connected()||this.emit(this._ON_NEED_ESTABLISH_P2P,t)))},e.prototype.removeNeighbour=function(t){var e=this,n=_.remove(this._neighbours,function(e){return e.peerID()===t});_.each(n,function(t){t.connected()&&e.emit(e._ON_NEED_CLOSE_P2P,t)})},e}(EventEmitter2);t.TargetNeighbours=e}(Model||(Model={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},Model;!function(t){var e=function(e){function n(n){var o=this;e.call(this),this._peer=n,this._neighbourSources={},this._defaultStream=[],this.establishLink=function(e){switch(e.type()){case t.NeighbourTypeEnum.video:o._tryCall(e);break;case t.NeighbourTypeEnum.data:o._tryConnect(e)}},this.onLinkEstablished=function(t){},this._onOnline=function(t){o._state.stateObject().network(o._state,t)},this._onOpenPeer=function(){o._state.stateObject().peer(o._state,!0)},this._onClosePeer=function(){o._state.stateObject().peer(o._state,!1)},this._onStateChanged=function(e){switch(e){case t.PeerJsStateEnum.initial:console.log("initial state");break;case t.PeerJsStateEnum.online:console.log("online state"),o._peer.disconnected||o._state.stateObject().peer(o._state,!0);break;case t.PeerJsStateEnum.connected:console.log("connected state"),setTimeout(o._establishAllPeer,t.Util.waitTime(0,2e3));break;case t.PeerJsStateEnum.wait_closing:console.log("wait closing state")}},this._establishAllPeer=function(){_.each(o._targetNeighbours(),o.establishLink)},this._onRecvCall=function(e){var n=e.peer;e.answer(o._defaultStream[0]);var i=o._targetNeighbours();if(i.hasOwnProperty(n)&&i[n].type()===t.NeighbourTypeEnum.video)e.close();else{var r=t.NeighbourFactory.createNeighbour(n,t.NeighbourTypeEnum.video);r.setChannel(e),o.onLinkEstablished(r)}},this._onRecvConnect=function(e){var n=e.peer,i=o._targetNeighbours();if(i.hasOwnProperty(n)&&i[n].type()===t.NeighbourTypeEnum.video)e.close();else{var r=t.NeighbourFactory.createNeighbour(n,t.NeighbourTypeEnum.data);r.setChannel(e),o.onLinkEstablished(r)}},this._state=new t.PeerJsStateManager,this._state.onStateChanged(this._onStateChanged),this._checkNetworkStatus(),this._wrapPeerEvent()}return __extends(n,e),n.prototype._checkNetworkStatus=function(){var t=this;Offline.options={checks:{xhr:{url:"https://skyway.io/dist/0.3/peer.min.js"}},reconnect:{initialDelay:3,delay:1.5}},Offline.on("up",function(){t._state.stateObject().network(t._state,!0)}),Offline.on("down",function(){t._state.stateObject().network(t._state,!1)}),"up"===Offline.state&&this._state.stateObject().network(this._state,!0)},n.prototype.addDefaultStream=function(t){t instanceof Array?Array.prototype.push.apply(this._defaultStream,t):this._defaultStream.push(t)},n.prototype.clearDefaultStream=function(){this._defaultStream=[]},n.prototype.addNeighboursSource=function(t,e){this._neighbourSources.hasOwnProperty(t)||(this._neighbourSources[t]=e)},n.prototype.removeNeighboursSource=function(t){this._neighbourSources.hasOwnProperty(t)&&delete this._neighbourSources[t]},n.prototype._wrapPeerEvent=function(){this._peer.on("open",this._onOpenPeer),this._peer.on("error",function(t){console.log(t)}),this._peer.on("disconnected",this._onClosePeer),this._peer.on("connection",this._onRecvConnect),this._peer.on("call",this._onRecvCall)},n.prototype._tryCall=function(t){var e=t.sources(),n=this._peer.call(t.peerID(),e[0]);t.setChannel(n),this.onLinkEstablished(t)},n.prototype._tryConnect=function(t){var e=this._peer.connect(t.peerID(),{label:"json",serialization:"none",reliable:!1});t.setChannel(e),this.onLinkEstablished(t)},n.prototype._targetNeighbours=function(){return _.reduce(this._neighbourSources,function(t,e,n){return $.extend(t,e())},[])},n}(EventEmitter2);t.PeerJsManager=e}(Model||(Model={}));var Model;!function(t){var e=function(){function t(){}return t.waitTime=function(t,e){return t+Math.random()*(e-t)},t}();t.Util=e}(Model||(Model={}));var PeerIo;!function(t){!function(t){t[t.video=1]="video",t[t.data=2]="data"}(t.EventTypeEnum||(t.EventTypeEnum={}));var e=t.EventTypeEnum,n=function(){function t(t){var e=this;this._dataListener=[],this._mediaListener=[],this.onLinkEstablish=function(t){switch(t.type()){case Model.NeighbourTypeEnum.video:t.onStream(e._notifyMedia);break;case Model.NeighbourTypeEnum.data:t.onData(e._notifyData)}},this._targetNeighbours=new Model.TargetNeighbours,this._peerJsManager=new Model.PeerJsManager(t),this._peerJsManager.addNeighboursSource("targetNeighbours",this._targetNeighbours.targetNeighbours),this._peerJsManager.onLinkEstablished=this.onLinkEstablish}return t.prototype.addDefaultStream=function(t){this._peerJsManager.addDefaultStream(t)},t.prototype.addNeighbour=function(t,e,n){var o=Model.NeighbourFactory.createNeighbour(t,e);n&&o.setSource(n),this._targetNeighbours.addNeighbour(o)},t.prototype.on=function(t,n){switch(t){case e.video:this._mediaListener.push(n);break;case e.data:this._dataListener.push(n)}},t.prototype.off=function(t,n){var o=[];switch(t){case e.video:o=this._mediaListener;break;case e.data:o=this._dataListener}var i=_.findIndex(o,function(t){return t==n});-1!==i&&o.splice(i,1)},t.prototype._notifyMedia=function(t,e){_.each(this._mediaListener,function(n){n(t,e)})},t.prototype._notifyData=function(t,e){_.each(this._dataListener,function(n){n(t,e)})},t}();t.PeerIo=n}(PeerIo||(PeerIo={}));