var PeerIo;!function(e){var t=function(){function t(){}return t.prototype.state=function(){return e.PeerJsStateEnum.initial},t.prototype.network=function(t,n){n&&t.setStateObject(new e.OnlineState)},t.prototype.peer=function(e,t){},t}();e.OfflineState=t}(PeerIo||(PeerIo={}));var PeerIo;!function(e){var t=function(){function t(){}return t.prototype.state=function(){return e.PeerJsStateEnum.online},t.prototype.network=function(t,n){n||t.setStateObject(new e.OfflineState)},t.prototype.peer=function(t,n){n&&t.setStateObject(new e.ConnectedState)},t}();e.OnlineState=t}(PeerIo||(PeerIo={}));var PeerIo;!function(e){var t=function(){function t(){}return t.prototype.state=function(){return e.PeerJsStateEnum.connected},t.prototype.network=function(t,n){n||t.setStateObject(new e.WaitClosingState)},t.prototype.peer=function(t,n){n||t.setStateObject(new e.OnlineState)},t}();e.ConnectedState=t}(PeerIo||(PeerIo={}));var PeerIo;!function(e){var t=function(){function t(){}return t.prototype.state=function(){return e.PeerJsStateEnum.wait_closing},t.prototype.network=function(t,n){n&&t.setStateObject(new e.ConnectedState)},t.prototype.peer=function(t,n){n||t.setStateObject(new e.OfflineState)},t}();e.WaitClosingState=t}(PeerIo||(PeerIo={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},PeerIo;!function(e){!function(e){e[e.initial=1]="initial",e[e.online=2]="online",e[e.connected=3]="connected",e[e.wait_closing=4]="wait_closing"}(e.PeerJsStateEnum||(e.PeerJsStateEnum={}));var t=(e.PeerJsStateEnum,function(t){function n(){t.call(this),this._ON_STATE_CHANGED="onStateCahnged",this._state=new e.OfflineState}return __extends(n,t),n.prototype.state=function(){return this._state.state()},n.prototype.stateObject=function(){return this._state},n.prototype.setStateObject=function(e){this._state=e,this.emit(this._ON_STATE_CHANGED,e.state())},n.prototype.onStateChanged=function(e){this.on(this._ON_STATE_CHANGED,e)},n}(EventEmitter2));e.PeerJsStateManager=t}(PeerIo||(PeerIo={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},PeerIo;!function(e){e.OnNeighbourDown="onNeighbourDown-in-neighbour.ts",e.OnStream="onStream-in-neighbour.ts",e.OnData="onData-in-neighbour.ts",function(e){e[e.video=1]="video",e[e.data=2]="data"}(e.NeighbourTypeEnum||(e.NeighbourTypeEnum={}));var t=e.NeighbourTypeEnum,n=function(e){function t(t){e.call(this),this._peerID=t,this._connected=!1}return __extends(t,e),t.prototype.connected=function(){return this._connected},t.prototype.type=function(){return null},t.prototype.peerID=function(){return this._peerID},t.prototype.sources=function(){return[]},t.prototype.setChannel=function(e){},t.prototype.setSource=function(e){},t.prototype.send=function(e){},t.prototype.close=function(){},t}(EventEmitter2);e.NeighbourTemplate=n;var o=function(n){function o(){n.apply(this,arguments),this._dataChannel=null}return __extends(o,n),o.prototype.type=function(){return t.data},o.prototype.setChannel=function(t){var n=this;t&&(this._dataChannel=t,this._connected=!1,t.on("open",function(){n._connected=!0}),t.on("close",function(){n._dataChannel=null,n._connected=!1,n.emit(e.OnNeighbourDown)}),t.on("error",function(e){n._dataChannel=null,n._connected=!1}),t.on("data",function(t){n.emit(e.OnData,t)}))},o.prototype.send=function(e){this._connected&&this._dataChannel&&this._dataChannel.send(e)},o.prototype.close=function(){this._dataChannel.close(),this._dataChannel=null,this._connected=!1},o}(n);e.DataNeighbour=o;var r=function(n){function o(){n.apply(this,arguments),this._mediaConnection=null,this._sources=[]}return __extends(o,n),o.prototype.type=function(){return t.video},o.prototype.sources=function(){return this._sources},o.prototype.setChannel=function(t){var n=this;this._mediaConnection=t,this._connected=!1,t.on("stream",function(t){n._mediaConnection=t,n._connected=!0,n.emit(e.OnStream,t)}),t.on("close",function(){n._mediaConnection=null,n._connected=!1,n.emit(e.OnNeighbourDown)}),t.on("error",function(e){n._mediaConnection=null,n._connected=!1})},o.prototype.setSource=function(e){e instanceof Array?Array.prototype.push.apply(this._sources,e):this._sources.push(e)},o.prototype.close=function(){this._mediaConnection.close(),this._mediaConnection=null,this._connected=!1},o}(n);e.VideoNeighbour=r;var i=function(){function e(){}return e.createNeighbour=function(e,n){switch(n){case t.video:return new r(e);case t.data:return new o(e)}},e}();e.NeighbourFactory=i}(PeerIo||(PeerIo={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},PeerIo;!function(e){var t=function(e){function t(){var t=this;e.call(this),this._neighbours=[],this._ON_NEED_ESTABLISH_P2P="onNeedEstablishP2P",this._ON_NEED_CLOSE_P2P="onNeedCloseP2P",this.targetNeighbours=function(){var e=_.filter(t._neighbours,function(e){return!e.connected()});return e}}return __extends(t,e),t.prototype.onNeedEstablishLink=function(e){this.on(this._ON_NEED_ESTABLISH_P2P,e)},t.prototype.onNeedCloseLink=function(e){this.on(this._ON_NEED_CLOSE_P2P,e)},t.prototype.addNeighbour=function(e){var t=_.find(this._neighbours,function(t){return t.peerID()===e.peerID()&&t.type()===e.type()});return t?void this.emit(this._ON_NEED_CLOSE_P2P,e):(this._neighbours.push(e),void(e.connected()||this.emit(this._ON_NEED_ESTABLISH_P2P,e)))},t.prototype.removeNeighbour=function(e){var t=this,n=_.remove(this._neighbours,function(t){return t.peerID()===e});_.each(n,function(e){e.connected()&&t.emit(t._ON_NEED_CLOSE_P2P,e)})},t}(EventEmitter2);e.TargetNeighbours=t}(PeerIo||(PeerIo={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},PeerIo;!function(e){var t=function(t){function n(n){var o=this;t.call(this),this._peer=n,this.ON_LINK_ESTABLISHED="onLinkEstablished",this._neighbourSources={},this._defaultStream=[],this.establishLink=function(t){switch(console.log("establishlink"),t.type()){case e.NeighbourTypeEnum.video:o._tryCall(t);break;case e.NeighbourTypeEnum.data:o._tryConnect(t)}},this._onOnline=function(e){o._state.stateObject().network(o._state,e)},this._onOpenPeer=function(){o._state.stateObject().peer(o._state,!0)},this._onClosePeer=function(){o._state.stateObject().peer(o._state,!1)},this._onStateChanged=function(t){switch(t){case e.PeerJsStateEnum.initial:break;case e.PeerJsStateEnum.online:o._peer.disconnected||o._state.stateObject().peer(o._state,!0);break;case e.PeerJsStateEnum.connected:setTimeout(o._establishAllPeer,e.Util.waitTime(0,2e3));break;case e.PeerJsStateEnum.wait_closing:}},this._establishAllPeer=function(){_.each(o._targetNeighbours(),o.establishLink)},this._onRecvCall=function(t){console.log("onrecvcall");var n=t.peer;t.answer(o._defaultStream[0]);var r=o._targetNeighbours();if(r.hasOwnProperty(n)&&r[n].type()===e.NeighbourTypeEnum.video)t.close();else{var i=e.NeighbourFactory.createNeighbour(n,e.NeighbourTypeEnum.video);i.setChannel(t),o.emit(o.ON_LINK_ESTABLISHED,i)}},this._onRecvConnect=function(t){console.log("onrecvconnect");var n=t.peer,r=o._targetNeighbours();if(r.hasOwnProperty(n)&&r[n].type()===e.NeighbourTypeEnum.video)t.close();else{var i=e.NeighbourFactory.createNeighbour(n,e.NeighbourTypeEnum.data);i.setChannel(t),o.emit(o.ON_LINK_ESTABLISHED,i)}},this._state=new e.PeerJsStateManager,this._state.onStateChanged(this._onStateChanged),this._checkNetworkStatus(),this._wrapPeerEvent()}return __extends(n,t),n.prototype._checkNetworkStatus=function(){var e=this;Offline.options={checks:{xhr:{url:"https://skyway.io/dist/0.3/peer.min.js"}}},Offline.on("up",function(){console.log("offline up"),e._state.stateObject().network(e._state,!0)}),Offline.on("down",function(){console.log("offline down"),e._state.stateObject().network(e._state,!1)}),"up"===Offline.state&&this._state.stateObject().network(this._state,!0),Offline.check()},n.prototype.addDefaultStream=function(e){e instanceof Array?Array.prototype.push.apply(this._defaultStream,e):this._defaultStream.push(e)},n.prototype.clearDefaultStream=function(){this._defaultStream=[]},n.prototype.addNeighboursSource=function(e,t){this._neighbourSources.hasOwnProperty(e)||(this._neighbourSources[e]=t)},n.prototype.removeNeighboursSource=function(e){this._neighbourSources.hasOwnProperty(e)&&delete this._neighbourSources[e]},n.prototype._wrapPeerEvent=function(){this._peer.on("open",this._onOpenPeer),this._peer.on("error",function(e){console.log(e)}),this._peer.on("disconnected",this._onClosePeer),this._peer.on("connection",this._onRecvConnect),this._peer.on("call",this._onRecvCall)},n.prototype._tryCall=function(e){console.log("trycall");var t=e.sources(),n=this._peer.call(e.peerID(),t[0]);e.setChannel(n),this.emit(this.ON_LINK_ESTABLISHED,e)},n.prototype._tryConnect=function(e){var t=this._peer.connect(e.peerID(),{label:"json",serialization:"none",reliable:!1});console.log("tryconnect"),e.setChannel(t),this.emit(this.ON_LINK_ESTABLISHED,e)},n.prototype._targetNeighbours=function(){return _.reduce(this._neighbourSources,function(e,t,n){return $.extend(e,t())},[])},n}(EventEmitter2);e.PeerJsManager=t}(PeerIo||(PeerIo={}));var PeerIo;!function(e){var t=function(){function e(){}return e.waitTime=function(e,t){return e+Math.random()*(t-e)},e}();e.Util=t}(PeerIo||(PeerIo={}));var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},PeerIo;!function(e){e.OnVideoLinkUp="onVideoLinkUp",e.OnVideoLinkDown="onVideoLinkDown",e.OnRecvVideo="onRecvVideo",e.OnDataLinkUp="onDataLinkUp",e.OnDataLinkDown="onDataLinkDown",e.OnRecvData="onRecvData",function(e){e[e.videoLinkUp=1]="videoLinkUp",e[e.recvVideo=2]="recvVideo",e[e.dataLinkUp=3]="dataLinkUp",e[e.recvData=4]="recvData"}(e.EventTypeEnum||(e.EventTypeEnum={}));var t=(e.EventTypeEnum,function(t){function n(n){var o=this;t.call(this),this._onLinkEstablish=function(t){switch(t.type()){case e.NeighbourTypeEnum.video:o.emit(e.OnVideoLinkUp,t.peerID()),t.on(e.OnStream,function(n){o.emit(e.OnRecvVideo,t.peerID(),n)}),t.on(e.OnNeighbourDown,function(){o.emit(e.OnVideoLinkDown,t.peerID())});break;case e.NeighbourTypeEnum.data:o.emit(e.OnDataLinkUp,t.peerID()),t.on(e.OnData,function(n){o.emit(e.OnRecvData,t.peerID(),n)}),t.on(e.OnNeighbourDown,function(){o.emit(e.OnDataLinkDown,t.peerID())})}},this._targetNeighbours=new e.TargetNeighbours,this._peerJsManager=new e.PeerJsManager(n),this._peerJsManager.addNeighboursSource("targetNeighbours",this._targetNeighbours.targetNeighbours),this._peerJsManager.on(this._peerJsManager.ON_LINK_ESTABLISHED,this._onLinkEstablish)}return __extends(n,t),n.prototype.addDefaultStream=function(e){this._peerJsManager.addDefaultStream(e)},n.prototype.addNeighbour=function(t,n,o){var r=e.NeighbourFactory.createNeighbour(t,n);o&&r.setSource(o),this._targetNeighbours.addNeighbour(r)},n}(EventEmitter2));e.PeerIo=t}(PeerIo||(PeerIo={}));